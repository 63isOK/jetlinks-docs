# 压力测试

压力测试主要对设备连接数以及设备消息处理速度进行测试.

测试场景:

1. 10万设备连接,不发送任何消息.
2. 30万设备连接,不发送任何消息.
3. 50万设备连接,不发送任何消息.
4. 10万设备连接,每秒随机3000个设备发送1条消息. 总计3000每秒
5. 30万设备连接,每秒随机5000个设备发送1条消息. 总计5000每秒
6. 50万设备连接,每秒随机10000个设备发送1条消息. 总计10000每秒

::: tip 注意
本测试在本地虚拟机中进行,屏蔽了网络环境影响,仅仅是对平台性能进行测试.
:::

## 压测环境

使用2个本地Linux虚拟机,一个作为服务端,一个作为压测客户端.

服务端虚拟机: 6核20G内存,ubuntu 16.4.

客户端虚拟机: 4核20G内存,ubuntu 16.4.

服务端使用[docker快速启动](/install-deployment/docker-start.md),除了`elasticsearch`和`jetlinks`对内存配置,没有做其他修改.

客户端使用[模拟器](https://github.com/jetlinks/device-simulator)批量模拟设备.

参考脚本:

```bash
#!/usr/bin/env bash
sudo sysctl -p
sudo ufw disable

# 创建虚拟网卡
for i in {10..40}; do sudo ifconfig enp0s6:$i 10.211.55.2$i up ;done

java -jar -Xmx16G -Xms1024m -XX:+UseG1GC device-simulator.jar \
mqtt.batchSize=1000 \
mqtt.port=1883 \
mqtt.address=10.211.55.6 \
mqtt.scriptFile=./scripts/demo-device.js \
mqtt.timeout=1000 \
mqtt.limit=200000 \
mqtt.enableEvent=false \
mqtt.eventLimit=40000 \
mqtt.eventRate=1000 \
mqtt.threadSize=128 \
mqtt.bindPortStart=10000 \
mqtt.binds=10.211.55.210,10.211.55.211,10.211.55.212,10.211.55.213,10.211.55.214,10.211.55.215\
,10.211.55.217,10.211.55.218,10.211.55.219,10.211.55.220,10.211.55.221,10.211.55.222,10.211.55.223\
,10.211.55.224,10.211.55.225,10.211.55.226,10.211.55.227,10.211.55.228,10.211.55.229,10.211.55.230\
,10.211.55.231,10.211.55.232,10.211.55.233,10.211.55.234,10.211.55.235,10.211.55.236,10.211.55.237\
,10.211.55.238,10.211.55.239
```
 