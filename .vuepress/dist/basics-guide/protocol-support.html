<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>平台消息协议定义 | jetlinks系统文档</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.6ebfbf8b.css" as="style"><link rel="preload" href="/assets/js/app.dc7074e4.js" as="script"><link rel="preload" href="/assets/js/2.910fdf72.js" as="script"><link rel="preload" href="/assets/js/38.521e74ad.js" as="script"><link rel="prefetch" href="/assets/js/10.eda24268.js"><link rel="prefetch" href="/assets/js/11.19531054.js"><link rel="prefetch" href="/assets/js/12.4eab3e27.js"><link rel="prefetch" href="/assets/js/13.a47f45a1.js"><link rel="prefetch" href="/assets/js/14.3e730a46.js"><link rel="prefetch" href="/assets/js/15.907667c2.js"><link rel="prefetch" href="/assets/js/16.8015f92a.js"><link rel="prefetch" href="/assets/js/17.b5a8d997.js"><link rel="prefetch" href="/assets/js/18.1d62f5d1.js"><link rel="prefetch" href="/assets/js/19.9e6eee02.js"><link rel="prefetch" href="/assets/js/20.26bbcf10.js"><link rel="prefetch" href="/assets/js/21.e0709ae7.js"><link rel="prefetch" href="/assets/js/22.ce25e9cd.js"><link rel="prefetch" href="/assets/js/23.169aa2b6.js"><link rel="prefetch" href="/assets/js/24.8bd84257.js"><link rel="prefetch" href="/assets/js/25.d591de57.js"><link rel="prefetch" href="/assets/js/26.9df4e7f5.js"><link rel="prefetch" href="/assets/js/27.0b93dd99.js"><link rel="prefetch" href="/assets/js/28.93a3408e.js"><link rel="prefetch" href="/assets/js/29.09f1942e.js"><link rel="prefetch" href="/assets/js/3.98eadc90.js"><link rel="prefetch" href="/assets/js/30.cf5724ec.js"><link rel="prefetch" href="/assets/js/31.795834ec.js"><link rel="prefetch" href="/assets/js/32.624235db.js"><link rel="prefetch" href="/assets/js/33.396cc821.js"><link rel="prefetch" href="/assets/js/34.d98c87d8.js"><link rel="prefetch" href="/assets/js/35.f43eb095.js"><link rel="prefetch" href="/assets/js/36.113e2390.js"><link rel="prefetch" href="/assets/js/37.8e34b117.js"><link rel="prefetch" href="/assets/js/39.33750cb1.js"><link rel="prefetch" href="/assets/js/4.4d6e2213.js"><link rel="prefetch" href="/assets/js/40.9c2067e2.js"><link rel="prefetch" href="/assets/js/41.da1c1528.js"><link rel="prefetch" href="/assets/js/42.a86acc07.js"><link rel="prefetch" href="/assets/js/43.01ac982b.js"><link rel="prefetch" href="/assets/js/44.b29351ad.js"><link rel="prefetch" href="/assets/js/45.02dee7fb.js"><link rel="prefetch" href="/assets/js/46.31030732.js"><link rel="prefetch" href="/assets/js/47.d886bd46.js"><link rel="prefetch" href="/assets/js/48.2dafc81e.js"><link rel="prefetch" href="/assets/js/49.3cf2fd42.js"><link rel="prefetch" href="/assets/js/5.d9fe38f8.js"><link rel="prefetch" href="/assets/js/50.9e3340e3.js"><link rel="prefetch" href="/assets/js/51.f9bbad75.js"><link rel="prefetch" href="/assets/js/52.f3090553.js"><link rel="prefetch" href="/assets/js/53.131e43b9.js"><link rel="prefetch" href="/assets/js/54.4af39627.js"><link rel="prefetch" href="/assets/js/55.332d5b71.js"><link rel="prefetch" href="/assets/js/56.468bb25a.js"><link rel="prefetch" href="/assets/js/57.5d23ec09.js"><link rel="prefetch" href="/assets/js/58.dbd31fff.js"><link rel="prefetch" href="/assets/js/59.52e0a5d6.js"><link rel="prefetch" href="/assets/js/6.e424fcf7.js"><link rel="prefetch" href="/assets/js/60.0adfc4b5.js"><link rel="prefetch" href="/assets/js/61.96074a66.js"><link rel="prefetch" href="/assets/js/62.7e859261.js"><link rel="prefetch" href="/assets/js/63.9503838f.js"><link rel="prefetch" href="/assets/js/64.04473a5c.js"><link rel="prefetch" href="/assets/js/65.6d5e6369.js"><link rel="prefetch" href="/assets/js/66.bebba830.js"><link rel="prefetch" href="/assets/js/7.078c9f18.js"><link rel="prefetch" href="/assets/js/8.616a6961.js"><link rel="prefetch" href="/assets/js/9.ba1a0650.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6ebfbf8b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">jetlinks系统文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="http://jetlinks.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  关于
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/jetlinks" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://gitee.com/jetlinks" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gitee
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/jetlinks/jetlinks-community/issues" target="_blank" rel="noopener noreferrer" class="nav-link external">
  提交问题
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/jetlinks/jetlinks-docs/issues" target="_blank" rel="noopener noreferrer" class="nav-link external">
  文档纠错
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="http://jetlinks.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  关于
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/jetlinks" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://gitee.com/jetlinks" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gitee
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/jetlinks/jetlinks-community/issues" target="_blank" rel="noopener noreferrer" class="nav-link external">
  提交问题
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/jetlinks/jetlinks-docs/issues" target="_blank" rel="noopener noreferrer" class="nav-link external">
  文档纠错
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/basics-guide/course/introduction.html" class="sidebar-link">介绍</a></li><li><a href="/basics-guide/quick-start.html" class="sidebar-link">快速开始</a></li><li><a href="/basics-guide/course/system-layout.html" class="sidebar-link">系统配置</a></li><li><a href="/basics-guide/device-manager.html" class="sidebar-link">设备管理</a></li><li><a href="/basics-guide/course/network.html" class="sidebar-link">网络组件</a></li><li><a href="/basics-guide/course/notification.html" class="sidebar-link">通知管理</a></li><li><a href="/basics-guide/course/rule-engine.html" class="sidebar-link">规则引擎</a></li><li><a href="/basics-guide/course/logger.html" class="sidebar-link">日志管理</a></li><li><a href="/basics-guide/course/data-visualization.html" class="sidebar-link">数据可视化(Pro)</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>进阶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/advancement-guide/jetlinks-protocol.html" class="sidebar-link">JetLinks官方协议说明</a></li><li><a href="/basics-guide/protocol-support.html" class="active sidebar-link">平台统一消息说明</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/basics-guide/protocol-support.html#认证器" class="sidebar-link">认证器</a></li><li class="sidebar-sub-header"><a href="/basics-guide/protocol-support.html#消息编解码器" class="sidebar-link">消息编解码器</a></li><li class="sidebar-sub-header"><a href="/basics-guide/protocol-support.html#平台统一消息定义" class="sidebar-link">平台统一消息定义</a></li><li class="sidebar-sub-header"><a href="/basics-guide/protocol-support.html#消息发送拦截器" class="sidebar-link">消息发送拦截器</a></li><li class="sidebar-sub-header"><a href="/basics-guide/protocol-support.html#配置元数据" class="sidebar-link">配置元数据</a></li><li class="sidebar-sub-header"><a href="/basics-guide/protocol-support.html#完整例子" class="sidebar-link">完整例子</a></li></ul></li><li><a href="/advancement-guide/mqtt-connection.html" class="sidebar-link">使用MQTT服务网关接入设备</a></li><li><a href="/advancement-guide/third-mqtt.html" class="sidebar-link">通过第三方MQTT服务接入设备</a></li><li><a href="/advancement-guide/tcp-connection.html" class="sidebar-link">使用TCP服务网关接入设备</a></li><li><a href="/advancement-guide/children-device.html" class="sidebar-link">接入网关设备,并通过网关代理接入子设备</a></li><li><a href="/advancement-guide/rule-engine-subscription.html" class="sidebar-link">通过规则引擎订阅设备消息,处理后发送邮件通知</a></li><li><a href="/advancement-guide/rule-engine-send.html" class="sidebar-link">通过规则引擎向其他设备发送消息</a></li><li><a href="/advancement-guide/create-data-visualization.html" class="sidebar-link">创建可视化图表,实时展示设备属性变更(PRO)</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>开发</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev-guide/start.html" class="sidebar-link">介绍</a></li><li><a href="/dev-guide/specification.html" class="sidebar-link">规范</a></li><li><a href="/dev-guide/reactor.html" class="sidebar-link">响应式</a></li><li><a href="/dev-guide/crud.html" class="sidebar-link">增删改查</a></li><li><a href="/dev-guide/event-driver.html" class="sidebar-link">事件驱动之消息网关</a></li><li><a href="/dev-guide/custom-message-protocol.html" class="sidebar-link">自定义消息协议</a></li><li><a href="/dev-guide/custom-notification-component.html" class="sidebar-link">自定义通知组件</a></li><li><a href="/dev-guide/send-message.html" class="sidebar-link">向设备发送消息</a></li><li><a href="/dev-guide/custom-dashboard.html" class="sidebar-link">自定义仪表盘</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>常见问题</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/common-problems/install.html" class="sidebar-link">安装,启动常见问题</a></li><li><a href="/common-problems/network-components.html" class="sidebar-link">网络组件常见问题</a></li><li><a href="/common-problems/mqtt-connection.html" class="sidebar-link">使用MQTT接入时的常见问题</a></li><li><a href="/common-problems/tcp-network-components.html" class="sidebar-link">TCP网络组件常见问题</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>HTTP接口文档</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interface-guide/authentication.html" class="sidebar-link">权限设置</a></li><li><a href="/interface-guide/device/device-product.html" class="sidebar-link">设备型号</a></li><li><a href="/interface-guide/device/device-instance.html" class="sidebar-link">设备实例</a></li><li><a href="/" class="sidebar-link">网络组件</a></li><li><a href="/" class="sidebar-link">设备接入</a></li><li><a href="/" class="sidebar-link">消息通知</a></li><li><a href="/" class="sidebar-link">openApi</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="平台消息协议定义"><a href="#平台消息协议定义" class="header-anchor">#</a> 平台消息协议定义</h1> <p>平台封装了网络通信,但是具体的数据由消息协议进行解析.<code>协议(ProtocolSupport)</code>主要由<code>认证器(Authenticator)</code>,
<code>消息编解码器(DeviceMessageCodec)</code>,<code>消息发送拦截器(DeviceMessageSenderInterceptor)</code>以及<code>配置元数据(ConfigMetadata)</code>组成.</p> <h2 id="认证器"><a href="#认证器" class="header-anchor">#</a> 认证器</h2> <p>认证器(Authenticator)是用于在收到设备请求(例如MQTT)时,对客户端进行认证时使用,不同的网络协议(Transport)使用不同的认证器.</p> <p>接口定义:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Authenticator</span> <span class="token punctuation">{</span>
    <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthenticationResponse</span><span class="token punctuation">&gt;</span></span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nonnull</span> <span class="token class-name">AuthenticationRequest</span> request<span class="token punctuation">,</span>
                                              <span class="token annotation punctuation">@Nonnull</span> <span class="token class-name">DeviceOperator</span> device<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>参数<code>AuthenticationRequest</code>为认证请求参数,不同的网络类型请求类型也不同,请根据实际情况转换为对应的类型,例如:
<code>MqttAuthenticationRequest mqttRequest = (MqttAuthenticationRequest)request;</code></p> <p>参数<code>DeviceOperator</code>为对应的设备操作接口,可通过此接口获取设备的配置,例如:<code>device.getConfig(&quot;mqttUsername&quot;)</code>.</p> <p>返回值<code>Mono&lt;AuthenticationResponse&gt;</code>为认证结果.</p> <p>例:</p> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token class-name">Authenticator</span> mqttAuthenticator <span class="token operator">=</span>  <span class="token punctuation">(</span>request<span class="token punctuation">,</span> device<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">MqttAuthenticationRequest</span> mqttRequest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MqttAuthenticationRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> device<span class="token punctuation">.</span><span class="token function">getConfigs</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span> <span class="token comment">//获取设备的配置信息,由配置元数据定义,在设备型号中进行配置.</span>
                    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>values <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                        <span class="token class-name">String</span> username <span class="token operator">=</span> values<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Value</span><span class="token operator">::</span><span class="token function">asString</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">String</span> password <span class="token operator">=</span> values<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Value</span><span class="token operator">::</span><span class="token function">asString</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>mqttRequest<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mqttRequest<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationResponse</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">&quot;密码错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre></div><h2 id="消息编解码器"><a href="#消息编解码器" class="header-anchor">#</a> 消息编解码器</h2> <p>用于将平台<code>统一的消息(Message)</code>与<code>设备端能处理的消息(EncodedMessage)</code>进行相互转换.</p> <p>接口(<code>DeviceMessageCodec</code>)定义:</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token comment">//此编解码器支持的网络协议,如: DefaultTransport.MQTT</span>
  <span class="token class-name">Transport</span> <span class="token function">getSupportTransport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//将平台发往设备的消息编码为设备端对消息</span>
  <span class="token class-name">Publisher</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">EncodedMessage</span><span class="token punctuation">&gt;</span></span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">MessageEncodeContext</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//将设备发往平台的消息解码为平台统一的消息</span>
  <span class="token class-name">Publisher</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">MessageDecodeContext</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>编码: 可以从上下文<code>MessageEncodeContext</code>中获取当前设备操作接口<code>DeviceOperator</code>以及平台统一的设备消息<code>Message</code>.根据设备侧定义的协议转换为对应的<code>EncodedMessage</code>.</p> <div class="custom-block tip"><p class="custom-block-title">注意</p> <p>不同的网络协议需要转换为不同的<code>EncodedMessage</code>类型.比如,MQTT需要转换为<code>MqttMessage</code>.</p> <p>大部分情况下:<code>MessageDecodeContext</code>可转为<code>FromDeviceMessageContext</code>,可获取到当前设备的连接会话<code>DeviceSession</code>,通过会话可以直接发送消息到设备.</p></div> <p>解码: 可以从上下文<code>MessageDecodeContext</code>中获取设备操作接口<code>DeviceOperator</code>以及设备消息<code>EncodedMessage</code>,然后将消息转换为平台统一的消息.</p> <h2 id="平台统一消息定义"><a href="#平台统一消息定义" class="header-anchor">#</a> 平台统一消息定义</h2> <p>平台将设备抽象为由<code>属性(property)</code>,<code>功能(function)</code>,<code>事件(event)</code>组成.
平台接入设备之前,应该先将设备的<code>属性``功能``事件</code>设计好.</p> <h3 id="属性相关消息"><a href="#属性相关消息" class="header-anchor">#</a> 属性相关消息</h3> <ol><li><code>获取设备属性(ReadPropertyMessage)</code>对应设备回复的消息<code>ReadPropertyMessageReply</code>.</li> <li><code>修改设备属性(WritePropertyMessage)</code>对应设备回复的消息<code>WritePropertyMessageReply</code>.</li> <li><code>设备上报属性(ReportPropertyMessage)</code> 由设备上报.</li></ol> <div class="custom-block tip"><p class="custom-block-title">注意</p> <p>设备回复的消息是通过messageId进行绑定,messageId应该注意要全局唯一,如果设备无法做到,可以在编解码时通过添加前缀等方式实现.</p></div> <p>消息定义:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ReadPropertyMessage</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> deviceId<span class="token punctuation">;</span> 
    <span class="token class-name">String</span> messageId<span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> properties<span class="token punctuation">;</span><span class="token comment">//可读取多个属性</span>
<span class="token punctuation">}</span>

<span class="token class-name">ReadPropertyMessageReply</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> deviceId<span class="token punctuation">;</span>
    <span class="token class-name">String</span> messageId<span class="token punctuation">;</span>
    <span class="token keyword">long</span> timestamp<span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> success<span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> properties<span class="token punctuation">;</span><span class="token comment">//属性键值对</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">WritePropertyMessage</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> deviceId<span class="token punctuation">;</span> 
    <span class="token class-name">String</span> messageId<span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> properties<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">WritePropertyMessageReply</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> deviceId<span class="token punctuation">;</span>
    <span class="token class-name">String</span> messageId<span class="token punctuation">;</span>
    <span class="token keyword">long</span> timestamp<span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> success<span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> properties<span class="token punctuation">;</span> <span class="token comment">//回复被修改的属性最新值</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ReportPropertyMessage</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> deviceId<span class="token punctuation">;</span> 
    <span class="token class-name">String</span> messageId<span class="token punctuation">;</span>
    <span class="token keyword">long</span> timestamp<span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> properties<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="功能相关消息"><a href="#功能相关消息" class="header-anchor">#</a> 功能相关消息</h3> <p>调用设备功能到消息(<code>FunctionInvokeMessage</code>)由平台发往设备,对应到返回消息<code>FunctionInvokeMessageReply</code>.</p> <p>消息定义:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">FunctionInvokeMessage</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> functionId<span class="token punctuation">;</span><span class="token comment">//功能标识,在元数据中定义.</span>
    <span class="token class-name">String</span> deviceId<span class="token punctuation">;</span>
    <span class="token class-name">String</span> messageId<span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FunctionParameter</span><span class="token punctuation">&gt;</span></span> inputs<span class="token punctuation">;</span><span class="token comment">//输入参数</span>
<span class="token punctuation">}</span>

<span class="token class-name">FunctionParameter</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token class-name">Object</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">FunctionInvokeMessageReply</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> deviceId<span class="token punctuation">;</span>
    <span class="token class-name">String</span> messageId<span class="token punctuation">;</span>
    <span class="token keyword">long</span> timestamp<span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> success<span class="token punctuation">;</span>
    <span class="token class-name">Object</span> output<span class="token punctuation">;</span> <span class="token comment">//输出值,需要与元数据定义中的类型一致</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="事件消息"><a href="#事件消息" class="header-anchor">#</a> 事件消息</h3> <p>事件消息<code>EventMessage</code>由设备端发往平台.</p> <p>消息定义:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">EventMessage</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> event<span class="token punctuation">;</span> <span class="token comment">//事件标识,在元数据中定义</span>
    <span class="token class-name">Object</span> data<span class="token punctuation">;</span>  <span class="token comment">//与元数据中定义的类型一致,如果是对象类型,请转为java.util.HashMap,禁止使用自定义类型.</span>
    <span class="token keyword">long</span> timestamp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="其他消息"><a href="#其他消息" class="header-anchor">#</a> 其他消息</h3> <ol><li><code>DeviceOnlineMessage</code> 设备上线消息,通常用于网关代理的子设备的上线操作.</li> <li><code>DeviceOfflineMessage</code> 设备上线消息,通常用于网关代理的子设备的下线操作.</li> <li><code>ChildrenDeviceMessage</code> 子设备消息,通常用于网关代理的子设备的消息.</li></ol> <p>消息定义:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">DeviceOnlineMessage</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> deviceId<span class="token punctuation">;</span>
    <span class="token keyword">long</span> timestamp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">DeviceOfflineMessage</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> deviceId<span class="token punctuation">;</span>
    <span class="token keyword">long</span> timestamp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ChildDeviceMessage</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> deviceId<span class="token punctuation">;</span>
    <span class="token class-name">String</span> childDeviceId<span class="token punctuation">;</span>
    <span class="token class-name">Message</span> childDeviceMessage<span class="token punctuation">;</span> <span class="token comment">//子设备消息</span>
<span class="token punctuation">}</span>
</code></pre></div><p>父子设备消息处理<a href="/advancement-guide/children-device.html">请看这里</a></p> <h2 id="消息发送拦截器"><a href="#消息发送拦截器" class="header-anchor">#</a> 消息发送拦截器</h2> <p>使用拦截器可以拦截消息发送和返回的动作,通过修改参数等操作实现自定义逻辑,如: 当设备离线时,将消息缓存到设备配置中,等设备上线时再重发.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">DeviceMessageSenderInterceptor</span><span class="token punctuation">{</span>
     <span class="token comment">//发送前</span>
      <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DeviceMessage</span><span class="token punctuation">&gt;</span></span> <span class="token function">preSend</span><span class="token punctuation">(</span><span class="token class-name">DeviceOperator</span> device<span class="token punctuation">,</span> <span class="token class-name">DeviceMessage</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token comment">//发送后</span>
      <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span> <span class="token keyword">extends</span> <span class="token class-name">DeviceMessage</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">afterSent</span><span class="token punctuation">(</span><span class="token class-name">DeviceOperator</span> device<span class="token punctuation">,</span> <span class="token class-name">DeviceMessage</span> message<span class="token punctuation">,</span> <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> reply<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在发送前,可以将参数<code>DeviceMessage</code>转为其他消息.</p> <p>发送后,会将返回结果流<code>Flux&lt;R&gt;</code>传入,通过对该数据流对操作以实现自定义行为,如:忽略错误等.</p> <h2 id="配置元数据"><a href="#配置元数据" class="header-anchor">#</a> 配置元数据</h2> <p>配置元数据用于告诉平台,在使用此协议等时候,需要添加一些自定义配置到设备(<code>DeviceOperator.setConfig</code>)中.</p> <p>例如:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">CompositeProtocolSupport</span> support <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompositeProtocolSupport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
support<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token string">&quot;demo-v1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
support<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;演示协议v1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
support<span class="token punctuation">.</span><span class="token function">setDescription</span><span class="token punctuation">(</span><span class="token string">&quot;演示协议&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
support<span class="token punctuation">.</span><span class="token function">setMetadataCodec</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JetLinksDeviceMetadataCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//固定为JetLinksDeviceMetadataCodec,请勿修改.</span>

<span class="token class-name">DefaultConfigMetadata</span> mqttConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConfigMetadata</span><span class="token punctuation">(</span>
            <span class="token string">&quot;MQTT认证配置&quot;</span>
            <span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;username&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;MQTT用户名&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StringType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;MQTT密码&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PasswordType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//设置MQTT所需要到配置</span>
 support<span class="token punctuation">.</span><span class="token function">addConfigMetadata</span><span class="token punctuation">(</span><span class="token class-name">DefaultTransport</span><span class="token punctuation">.</span>MQTT<span class="token punctuation">,</span> mqttConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="完整例子"><a href="#完整例子" class="header-anchor">#</a> 完整例子</h2> <p><a href="https://github.com/jetlinks/demo-protocol" target="_blank" rel="noopener noreferrer">演示协议<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/advancement-guide/jetlinks-protocol.html" class="prev">JetLinks官方协议说明</a></span> <span class="next"><a href="/advancement-guide/mqtt-connection.html">使用MQTT服务网关接入设备</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.dc7074e4.js" defer></script><script src="/assets/js/2.910fdf72.js" defer></script><script src="/assets/js/38.521e74ad.js" defer></script>
  </body>
</html>
